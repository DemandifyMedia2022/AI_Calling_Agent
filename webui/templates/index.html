{% extends "base.html" %}
{% block content %}
  <section class="controls">
    <form id="campaignForm" class="controls-form">
      <label for="campaign">Campaign</label>
      <select name="campaign" id="campaign" class="select">
        {% for opt in campaign_options %}
          <option value="{{ opt.key }}" {% if opt.selected %}selected{% endif %}>{{ opt.label }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn primary">Apply</button>
    </form>
    <div id="campaignBadge" class="badge {% if not campaign %}warning{% endif %}">Campaign: <strong>{% if campaign_label %}{{ campaign_label }}{% elif campaign %}{{ campaign }}{% else %}Not set{% endif %}</strong></div>
    <label style="display:flex; align-items:center; gap:6px;margin-top:8px">
      <input type="checkbox" id="autoNextToggle" /> Auto Next
    </label>
  </section>

  <section id="statusPanel" class="status-panel">
    <div class="badge">Status: <strong id="callStatus">idle</strong><span id="statusDetails" style="margin-left:8px; color:#666;"></span></div>
    <div style="margin-left:auto; display:flex; gap:16px; flex-wrap:wrap; align-items:center;margin-top:8px">
      {# Compute next pointer (start_index + count shown) #}
      <button id="callNextBtn" class="btn" data-next-index="{{ start_index + leads|length }}">Call Next</button>
      <button id="endCallBtn" class="btn danger" disabled>End Current Call</button>
      <button id="stopAllBtn" class="btn danger ghost">End Session</button>
    </div>
  </section>

  <section id="currentCallSection" style="display:none;">
    <div id="currentCallCard" class="call-card">
      <div class="avatar">
        <div id="callSpinner" class="spinner"></div>
      </div>
      <div style="flex:1;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;margin-top:18px">
          <h3 id="callHeadline" style="margin:1px; font-size:18px;">Connecting…</h3>
          <span id="callChip" class="chip">Waiting</span>
        </div>
        <div id="callProspect" style="font-size:16px; font-weight:600; margin-bottom:2px;">—</div>
        <div id="callCompany" class="muted" style="font-size:14px; margin-bottom:8px;">—</div>
        <div style="display:flex; gap:16px; flex-wrap:wrap; color:#d1d5db; font-size:13px;">
          <div><strong>Title:</strong> <span id="callJob">—</span></div>
          <div><strong>Phone:</strong> <span id="callPhone">—</span></div>
          <div><strong>Email:</strong> <span id="callEmail">—</span></div>
          <div><strong>Timezone:</strong> <span id="callTz">—</span></div>
          <div><strong>Campaign:</strong> <span id="callCampaign">—</span></div>
        </div>
      </div>
    </div>
  </section>

  <section class="leads">
    <div class="leads-header">
      <h2>Prospects (Page {{ page }}/{{ total_pages }})</h2>
      <div class="pager">
        {% if page > 1 %}
          <a class="btn ghost" href="/?page={{ page - 1 }}{% if campaign %}&campaign={{ campaign }}{% endif %}">Prev</a>
        {% endif %}
        {% if page < total_pages %}
          <a class="btn ghost" href="/?page={{ page + 1 }}{% if campaign %}&campaign={{ campaign }}{% endif %}">Next</a>
        {% endif %}
      </div>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Prospect</th>
          <th>Company</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for lead in leads %}
          <tr>
            <td>{{ loop.index + start_index }}</td>
            <td>{{ lead.prospect_name }}</td>
            <td>{{ lead.company_name }}</td>
            <td>
              <button class="btn primary startCallBtn" data-lead-index="{{ loop.index0 + start_index }}"
                data-prospect-name="{{ lead.prospect_name }}"
                data-company-name="{{ lead.company_name }}"
                data-job-title="{{ lead.job_title if lead.job_title is defined else '' }}"
                data-phone="{{ lead.phone if lead.phone is defined else '' }}"
                data-email="{{ lead.email if lead.email is defined else '' }}"
                data-timezone="{{ lead.timezone if lead.timezone is defined else '' }}"
              >Start Call</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Numeric pagination -->
    <nav class="pagination">
      {% for p in range(1, total_pages + 1) %}
        <a class="page-link {% if p == page %}active{% endif %}" href="/?page={{ p }}{% if campaign %}&campaign={{ campaign }}{% endif %}">{{ p }}</a>
      {% endfor %}
    </nav>
  </section>
  <div id="toastContainer" class="toast-container"></div>
  <script>
    (function(){
      const statusEl = document.getElementById('callStatus');
      const detailsEl = document.getElementById('statusDetails');
      const endBtn = document.getElementById('endCallBtn');
      const campaignForm = document.getElementById('campaignForm');
      const campaignSelect = document.getElementById('campaign');
      const campaignBadge = document.getElementById('campaignBadge');
      const nextBtn = document.getElementById('callNextBtn');
      const autoNextToggle = document.getElementById('autoNextToggle');
      const stopAllBtn = document.getElementById('stopAllBtn');
      const callSection = document.getElementById('currentCallSection');
      const callHeadline = document.getElementById('callHeadline');
      const callChip = document.getElementById('callChip');
      const callProspect = document.getElementById('callProspect');
      const callCompany = document.getElementById('callCompany');
      const callJob = document.getElementById('callJob');
      const callPhone = document.getElementById('callPhone');
      const callEmail = document.getElementById('callEmail');
      const callTz = document.getElementById('callTz');
      const callCampaign = document.getElementById('callCampaign');
      const callSpinner = document.getElementById('callSpinner');
      const topProgress = document.getElementById('topProgress');

      let lastRunning = false;
      let lastLead = null;

      function toast(msg, type='info'){
        const wrap = document.getElementById('toastContainer');
        const el = document.createElement('div');
        el.className = 'toast ' + (type || 'info');
        el.textContent = msg;
        wrap.appendChild(el);
        requestAnimationFrame(() => { el.style.opacity = '1'; });
        setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 300ms'; }, 2400);
        setTimeout(() => { if (el.parentNode===wrap) wrap.removeChild(el); }, 2800);
      }

      function startProgress(){
        if (!topProgress) return;
        topProgress.style.opacity = '1';
        topProgress.style.width = '30%';
        requestAnimationFrame(() => { topProgress.style.width = '60%'; });
      }
      function endProgress(){
        if (!topProgress) return;
        topProgress.style.width = '100%';
        setTimeout(() => { topProgress.style.opacity = '0'; topProgress.style.width = '0%'; }, 250);
      }

      async function postForm(url, data){
        const body = new URLSearchParams();
        for (const [k,v] of Object.entries(data)){
          if (v !== undefined && v !== null){ body.append(k, String(v)); }
        }
        startProgress();
        const res = await fetch(url, { method: 'POST', body });
        endProgress();
        if (!res.ok) throw new Error('Request failed');
        return await res.json();
      }

      async function refreshStatus(){
        try {
          const res = await fetch('/api/status');
          const data = await res.json();
          statusEl.textContent = data.status || 'idle';
          const label = data.lead_index ? `Lead #${data.lead_index}` : '';
          const campName = data.campaign_label || data.campaign || '';
          const camp = campName ? ` | Campaign: ${campName}` : '';
          detailsEl.textContent = `${label}${camp}`;
          endBtn.disabled = !(data.running);
          // Sync auto-next toggle
          if (typeof data.auto_next === 'boolean') {
            autoNextToggle.checked = data.auto_next;
          }

          // Toast on transitions
          const running = !!data.running;
          if (!lastRunning && running) {
            toast(`Call connected ${label ? '('+label+')' : ''}`, 'success');
            // Mark card as connected
            callSpinner.style.display = 'none';
            callHeadline.textContent = 'Connected';
            callChip.textContent = 'Live';
            callChip.style.background = '#064e3b';
            callChip.style.color = '#34d399';
          } else if (lastRunning && !running) {
            toast('Call ended', 'info');
            // Hide card when fully idle
            callSection.style.display = 'none';
            // Clear stored prospect
            callProspect.dataset.prospect = '';
          }
          lastRunning = running;
          lastLead = data.lead_index || null;

          // Update card details when lead changes
          if (data.lead && (callProspect.dataset.prospect !== (data.lead.prospect_name || '') || callSection.style.display === 'none')){
            callProspect.textContent = data.lead.prospect_name || '—';
            callProspect.dataset.prospect = data.lead.prospect_name || '';
            callCompany.textContent = data.lead.company_name || '—';
            callJob.textContent = data.lead.job_title || '—';
            callPhone.textContent = data.lead.phone || '—';
            callEmail.textContent = data.lead.email || '—';
            callTz.textContent = data.lead.timezone || '—';
            callCampaign.textContent = campName || '—';
            callSection.style.display = 'block';
            // If not running yet, show connecting state
            if (!running){
              callSpinner.style.display = 'block';
              callHeadline.textContent = 'Connecting…';
              callChip.textContent = 'Waiting';
              callChip.style.background = '#1f2937';
              callChip.style.color = '#a7f3d0';
            }
          }
          // If not running and no active lead, hide and clear
          if (!running && !data.lead_index) {
            callSection.style.display = 'none';
            callProspect.dataset.prospect = '';
            callProspect.textContent = '—';
            callCompany.textContent = '—';
            callJob.textContent = '—';
            callPhone.textContent = '—';
            callEmail.textContent = '—';
            callTz.textContent = '—';
            callCampaign.textContent = '—';
          }
        } catch(e) {
          // ignore
        }
      }

      // Wire campaign selection (no full page reload)
      campaignForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const val = campaignSelect.value || '';
        try {
          const resp = await postForm('/api/select_campaign', { campaign: val });
          const label = (resp && resp.campaign_label) ? resp.campaign_label : (val || 'Not set');
          campaignBadge.innerHTML = 'Campaign: <strong>' + label + '</strong>';
          if (!val) { campaignBadge.classList.add('warning'); }
          else { campaignBadge.classList.remove('warning'); }
          toast('Campaign applied', 'success');
        } catch(e) {
          alert('Failed to set campaign');
        }
      });

      // Start call for a specific lead
      document.querySelectorAll('.startCallBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.getAttribute('data-lead-index'));
          const camp = campaignSelect.value || '';
          // Populate card immediately with known details
          callProspect.textContent = btn.getAttribute('data-prospect-name') || '—';
          callProspect.dataset.prospect = btn.getAttribute('data-prospect-name') || '';
          callCompany.textContent = btn.getAttribute('data-company-name') || '—';
          callJob.textContent = btn.getAttribute('data-job-title') || '—';
          callPhone.textContent = btn.getAttribute('data-phone') || '—';
          callEmail.textContent = btn.getAttribute('data-email') || '—';
          callTz.textContent = btn.getAttribute('data-timezone') || '—';
          callCampaign.textContent = campaignSelect.options[campaignSelect.selectedIndex]?.text || '—';
          callSpinner.style.display = 'block';
          callHeadline.textContent = 'Connecting…';
          callChip.textContent = 'Waiting';
          callChip.style.background = '#1f2937';
          callChip.style.color = '#a7f3d0';
          callSection.style.display = 'block';
          try {
            btn.disabled = true;
            await postForm('/api/start_call', { lead_global_index: idx, campaign: camp });
            setTimeout(refreshStatus, 300);
          } catch(e) {
            alert('Failed to start call');
          } finally { btn.disabled = false; }
        });
      });

      // Call Next (Console)
      if (nextBtn){
        nextBtn.addEventListener('click', async () => {
          const nextIdx = parseInt(nextBtn.getAttribute('data-next-index'));
          const camp = campaignSelect.value || '';
          try {
            nextBtn.disabled = true;
            await postForm('/api/start_call', { lead_global_index: nextIdx, campaign: camp });
            setTimeout(refreshStatus, 300);
          } catch(e) {
            alert('Failed to start next call');
          } finally { nextBtn.disabled = false; }
        });
      }

      // End current call (auto-next enabled by default)
      endBtn.addEventListener('click', async () => {
        try {
          endBtn.disabled = true;
          await postForm('/api/end_call', { auto_next: autoNextToggle.checked });
          setTimeout(refreshStatus, 500);
        } catch(e) {
          alert('Failed to end call');
        } finally { endBtn.disabled = false; }
      });

      // Auto Next toggle
      autoNextToggle.addEventListener('change', async () => {
        try {
          await postForm('/api/auto_next', { enabled: autoNextToggle.checked });
          toast('Auto Next ' + (autoNextToggle.checked ? 'enabled' : 'disabled'), 'info');
        } catch(e) {
          alert('Failed to update Auto Next');
        }
      });

      // End whole session
      stopAllBtn.addEventListener('click', async () => {
        try {
          stopAllBtn.disabled = true;
          await postForm('/api/stop_all', {});
          setTimeout(refreshStatus, 400);
          toast('Session ended', 'error');
        } catch(e) {
          alert('Failed to end session');
        } finally { stopAllBtn.disabled = false; }
      });

      // Show progress when clicking pagination
      document.querySelectorAll('.page-link').forEach(a => {
        a.addEventListener('click', () => { startProgress(); });
      });

      // Poll status
      refreshStatus();
      setInterval(refreshStatus, 1000);
    })();
  </script>
{% endblock %}

